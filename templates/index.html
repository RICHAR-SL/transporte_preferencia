<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Preferencia de Transporte</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="container py-4">

  <h1 class="mb-4">📊 Encuesta: Preferencia de Transporte</h1>

  <!-- Nueva Encuesta -->
  <div class="card mb-4">
    <div class="card-header">📝 Nueva Respuesta</div>
    <div class="card-body">
      <form id="encuestaForm">
        <div class="row mb-3">
          <div class="col">
            <input type="text" class="form-control" placeholder="Nombre" name="nombre" required>
          </div>
          <div class="col">
            <input type="text" class="form-control" placeholder="Apellido" name="apellido">
          </div>
        </div>
        <input type="text" class="form-control mb-3" placeholder="Escuela" name="escuela">
        <select class="form-select mb-3" name="transporte" required>
          <option value="">-- Selecciona Transporte --</option>
          <option value="Bus">Bus</option>
          <option value="Bicicleta">Bicicleta</option>
          <option value="Auto">Auto</option>
          <option value="Caminando">Caminando</option>
        </select>
        <textarea class="form-control mb-3" placeholder="Comentario" name="comentario"></textarea>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>
  </div>

  <!-- Resultados -->
  <div class="card mb-4">
    <div class="card-header">📈 Resultados</div>
    <div class="card-body">
      <p>Total de respuestas: <span id="total">0</span></p>
      <ul id="conteo"></ul>
      <img id="grafico" class="img-fluid" alt="Gráfico de transporte">
    </div>
  </div>

  <!-- Descargar -->
  <div class="mb-4">
    <a href="/api/export" class="btn btn-success">⬇️ Descargar CSV</a>
  </div>

<script>
  async function cargarResultados() {
    const res = await axios.get('/api/data');
    document.getElementById('total').innerText = res.data.total;
    const conteo = document.getElementById('conteo');
    conteo.innerHTML = '';
    for (const [key, value] of Object.entries(res.data.counts)) {
      conteo.innerHTML += `<li>${key}: ${value}</li>`;
    }
    document.getElementById('grafico').src = '/api/chart/pie.png?' + new Date().getTime();
  }

  document.getElementById('encuestaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = {
      nombre: form.nombre.value,
      apellido: form.apellido.value,
      escuela: form.escuela.value,
      transporte: form.transporte.value,
      comentario: form.comentario.value
    };
    await axios.post('/api/submit', data);
    form.reset();
    cargarResultados();
  });

  cargarResultados();
</script>

</body>
</html>
